<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JEE Price Guide</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      padding-top: var(--header-height);
    }

    #topHeader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #0f172a;
      z-index: 100;
      padding: 16px 20px 0 20px;
      border-bottom: 1px solid #1e293b;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    h1 {
      margin: 0;
      color: #facc15;
      font-size: 26px;
      text-align: left;
    }

    .sub-info {
      font-size: 12px;
      margin: 4px 0 8px 0;
      color: #38bdf8;
      text-align: left;
    }

    .sub-info a {
      color: #60a5fa;
      text-decoration: underline;
    }

    /* Website Last Updated */
    #siteUpdatedBar {
      margin-top: 14px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #38bdf8;
      font-weight: 500;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .controls input,
    .controls select {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
    }

    #headerWrapper {
      position: sticky;
      top: var(--header-height);
      z-index: 90;
    }

    #headerTable {
      width: 100%;
      border-collapse: collapse;
      background: #111827;
      border-top: 1px solid #1f2937;
      border-bottom: 1px solid #1f2937;
      table-layout: fixed;
    }

    #headerTable th {
      padding: 12px 14px;
      text-align: left;
      font-size: 14px;
      font-weight: bold;
      color: #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #020617;
      table-layout: fixed;
    }

    td {
      padding: 12px 14px;
      border-bottom: 1px solid #1f2937;
      font-size: 14px;
      vertical-align: middle;
      text-align: left;
      overflow-wrap: break-word;
    }

    tr:hover {
      background: #0f1a33;
      box-shadow: inset 0 0 0 1px #3b82f6;
    }

    .category-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      background: #1e293b;
      color: #93c5fd;
      border: 1px solid #334155;
      cursor: pointer;
    }

    .price-tag {
      font-weight: 700;
      color: #facc15;
      font-size: 15px;
    }

    .price-coins {
      color: #64748b;
      font-size: 12px;
      margin-left: 2px;
    }

    .updated-date {
      color: #38bdf8;
      font-size: 13px;
      white-space: nowrap;
    }

    /* Calculator */
    #calcContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    #calcToggle {
      background: #1d4ed8;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    #calcPanel {
      width: 280px;
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 15px;
      margin-top: 10px;
      display: none;
      position: absolute;
      right: 0;
      top: 40px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
    }

    .calc-display {
      background: #1e293b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      text-align: right;
      color: white;
    }

    #calcScreen {
      font-size: 28px;
      font-weight: bold;
      min-height: 32px;
    }

    .calc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      background: #1e293b;
      color: white;
    }

    .btn.eq { background: #2563eb; grid-row: span 2; }
    .btn.ac { background: #dc2626; }
  </style>
</head>

<body>

  <div id="calcContainer">
    <button id="calcToggle">Calculator</button>
    <div id="calcPanel">
      <div class="calc-display"><div id="calcScreen">0</div></div>
      <div class="calc-grid">
        <button class="btn ac">AC</button>
        <button class="btn op">÷</button>
        <button class="btn op">×</button>
        <button class="btn op">-</button>
        <button class="btn num">7</button>
        <button class="btn num">8</button>
        <button class="btn num">9</button>
        <button class="btn op">+</button>
        <button class="btn num">4</button>
        <button class="btn num">5</button>
        <button class="btn num">6</button>
        <button class="btn op">(</button>
        <button class="btn num">1</button>
        <button class="btn num">2</button>
        <button class="btn num">3</button>
        <button class="btn op">)</button>
        <button class="btn num zero">0</button>
        <button class="btn op">%</button>
        <button class="btn" id="backspaceBtn">⌫</button>
        <button class="btn eq">=</button>
      </div>
    </div>
  </div>

  <div id="topHeader">
    <h1>JEE Price Guide</h1>

    <div class="sub-info">
      By Melted — Join our Discord:
      <a href="https://discord.gg/sMxq3vGX2w" target="_blank">discord.gg/sMxq3vGX2w</a>
    </div>

    <!-- Manual Last Updated (ISO stored in data-updated) -->
    <div id="siteUpdatedBar" data-updated="2026-02-14">
      Last Updated:
    </div>

    <div class="controls">
      <input id="search" type="text" placeholder="Search item..." />
      <select id="categoryFilter"><option value="">All categories</option></select>
      <select id="subcategoryFilter"><option value="">All subcategories</option></select>
      <select id="sort">
        <option value="name_asc">Sort: Name (A → Z)</option>
        <option value="name_desc">Sort: Name (Z → A)</option>
        <option value="price_asc">Sort: Price (Low → High)</option>
        <option value="price_desc">Sort: Price (High → Low)</option>
        <option value="updated_desc">Sort: Newest Updated</option>
        <option value="updated_asc">Sort: Oldest Updated</option>
      </select>
    </div>
  </div>

  <div id="headerWrapper">
    <table id="headerTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Category</th>
          <th>Price</th>
          <th>Last Updated</th>
        </tr>
      </thead>
    </table>
  </div>

  <table id="priceTable">
    <tbody></tbody>
  </table>
  <script>
  /* -------------------------------
     HEADER HEIGHT FIX
  --------------------------------*/
  function updateHeaderHeight() {
    const header = document.getElementById("topHeader");
    const height = header.offsetHeight;
    document.documentElement.style.setProperty("--header-height", height + "px");
  }

  window.addEventListener("load", updateHeaderHeight);
  window.addEventListener("resize", updateHeaderHeight);

  /* -------------------------------
     CATEGORY FILTER CLICK
  --------------------------------*/
  function filterByCategory(cat) {
    CATEGORY_FILTER.value = cat;
    SUBCATEGORY_FILTER.value = "";
    renderTable();
  }

  /* -------------------------------
     CALCULATOR
  --------------------------------*/
  const calcToggle = document.getElementById("calcToggle");
  const calcPanel = document.getElementById("calcPanel");
  const calcScreen = document.getElementById("calcScreen");
  const backspaceBtn = document.getElementById("backspaceBtn");
  let calcInput = "";

  function updateScreen() {
    calcScreen.textContent = calcInput || "0";
  }

  calcToggle.onclick = () => {
    calcPanel.style.display = calcPanel.style.display === "block" ? "none" : "block";
  };

  document.querySelectorAll(".btn.num").forEach(btn => {
    btn.onclick = () => { calcInput += btn.textContent; updateScreen(); };
  });

  document.querySelectorAll(".btn.op").forEach(btn => {
    btn.onclick = () => { calcInput += btn.textContent; updateScreen(); };
  });

  document.querySelector(".btn.ac").onclick = () => { calcInput = ""; updateScreen(); };
  backspaceBtn.onclick = () => { calcInput = calcInput.slice(0, -1); updateScreen(); };

  document.querySelector(".btn.eq").onclick = () => {
    try {
      let expr = calcInput
        .replace(/×/g, "*")
        .replace(/÷/g, "/")
        .replace(/(\d+)%/g, "($1/100)");
      calcInput = eval(expr).toString();
    } catch {
      calcInput = "Error";
    }
    updateScreen();
  };

  /* -------------------------------
     GLOBAL ELEMENTS
  --------------------------------*/
  const TABLE_BODY = document.querySelector("#priceTable tbody");
  const SEARCH_INPUT = document.getElementById("search");
  const CATEGORY_FILTER = document.getElementById("categoryFilter");
  const SUBCATEGORY_FILTER = document.getElementById("subcategoryFilter");
  const SORT_SELECT = document.getElementById("sort");
  const SITE_UPDATED_BAR = document.getElementById("siteUpdatedBar");

  let items = [];
  let openRow = null; // track which dropdown is open

  /* -------------------------------
     HELPERS
  --------------------------------*/
  function shortenNumber(n) {
    if (n >= 1e12) return (n/1e12).toFixed(2).replace(/\.00$/,"")+"T";
    if (n >= 1e9) return (n/1e9).toFixed(2).replace(/\.00$/,"")+"B";
    if (n >= 1e6) return (n/1e6).toFixed(2).replace(/\.00$/,"")+"M";
    if (n >= 1e3) return (n/1e3).toFixed(2).replace(/\.00$/,"")+"k";
    return n.toString();
  }

  function formatDate(iso) {
    if (!iso) return "-";
    const dateOnly = iso.split("T")[0];
    const [y, m, d] = dateOnly.split("-");
    return `${d}/${m}/${y}`;
  }

  function timeAgo(iso) {
    if (!iso) return "";

    const dateOnly = iso.split("T")[0];
    const updatedDate = new Date(dateOnly);
    const now = new Date();

    const diffMs = now - updatedDate;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays <= 0) return "Today";
    if (diffDays === 1) return "Yesterday";
    if (diffDays < 30) return `${diffDays} days ago`;

    const months = Math.floor(diffDays / 30);
    if (months === 1) return "1 month ago";
    return `${months} months ago`;
  }

  function buildCategoryOptions(data) {
    const cats = new Set();
    const subs = new Set();

    data.forEach(i => {
      if (i.category) cats.add(i.category);
      if (i.subcategory) subs.add(i.subcategory);
    });

    [...cats].sort().forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      CATEGORY_FILTER.appendChild(opt);
    });

    [...subs].sort().forEach(sub => {
      const opt = document.createElement("option");
      opt.value = sub;
      opt.textContent = sub;
      SUBCATEGORY_FILTER.appendChild(opt);
    });
  }

  /* -------------------------------
     RENDER TABLE + DROPDOWN
  --------------------------------*/
  function renderTable() {
    const search = SEARCH_INPUT.value.trim().toLowerCase();
    const cat = CATEGORY_FILTER.value;
    const sub = SUBCATEGORY_FILTER.value;
    const sort = SORT_SELECT.value;

    let filtered = items.filter(i =>
      (!search || i.name.toLowerCase().includes(search)) &&
      (!cat || i.category === cat) &&
      (!sub || i.subcategory === sub)
    );

    filtered.sort((a, b) => {
      switch (sort) {
        case "name_asc": return a.name.localeCompare(b.name);
        case "name_desc": return b.name.localeCompare(a.name);
        case "price_asc": return a.price - b.price;
        case "price_desc": return b.price - a.price;
        case "updated_desc": return (b.updated || "").localeCompare(a.updated || "");
        case "updated_asc": return (a.updated || "").localeCompare(b.updated || "");
      }
    });

    TABLE_BODY.innerHTML = "";
    openRow = null;

    filtered.forEach(it => {
      const tr = document.createElement("tr");
      tr.classList.add("item-row");

      tr.innerHTML = `
        <td>${it.name}</td>
        <td>
          <span class="category-badge" onclick="filterByCategory('${it.category}')">
            ${it.category || "Uncategorised"}${it.subcategory ? " / " + it.subcategory : ""}
          </span>
        </td>
        <td>
          <span class="price-tag">${shortenNumber(it.price)}</span>
          <span class="price-coins">Coins</span>
        </td>
        <td>
          <span class="updated-date">${timeAgo(it.updated)}</span>
        </td>
      `;

      // Dropdown row
      const drop = document.createElement("tr");
      drop.classList.add("dropdown-row");
      drop.style.display = "none";

      drop.innerHTML = `
        <td colspan="4" style="background:#0f172a; padding:14px; border-bottom:1px solid #1f2937;">
          <div style="line-height:1.6;">
            <div><strong>Price:</strong> ${it.price.toLocaleString()} coins</div>
            <div><strong>Category:</strong> ${it.category || "None"}</div>
            <div><strong>Subcategory:</strong> ${it.subcategory || "None"}</div>
            <div><strong>Last Updated:</strong> ${formatDate(it.updated)}</div>
            <div><strong>Updated:</strong> ${timeAgo(it.updated)}</div>
          </div>
        </td>
      `;

      // Click to toggle dropdown
      tr.addEventListener("click", () => {
        if (openRow && openRow !== drop) {
          openRow.style.display = "none";
        }

        if (drop.style.display === "none") {
          drop.style.display = "table-row";
          openRow = drop;
        } else {
          drop.style.display = "none";
          openRow = null;
        }
      });

      TABLE_BODY.appendChild(tr);
      TABLE_BODY.appendChild(drop);
    });
  }

  /* -------------------------------
     LOAD DATA + WEBSITE TIME AGO
  --------------------------------*/
  async function loadData() {
    try {
      const res = await fetch("data.json");
      const raw = await res.json();

      items = Object.entries(raw)
        .filter(([name]) => name !== "logs")
        .map(([name, info]) => ({
          name,
          price: info.price || 0,
          category: info.category || "",
          subcategory: info.subcategory || "",
          updated: info.updated || ""
        }));

      const siteIso = SITE_UPDATED_BAR.dataset.updated;
      if (siteIso) {
        SITE_UPDATED_BAR.textContent = "Last Updated: " + timeAgo(siteIso);
      }

      buildCategoryOptions(items);
      renderTable();

    } catch {
      TABLE_BODY.innerHTML = `<tr><td colspan="4">Failed to load data.json</td></tr>`;
    }
  }

  SEARCH_INPUT.oninput = renderTable;
  CATEGORY_FILTER.onchange = renderTable;
  SUBCATEGORY_FILTER.onchange = renderTable;
  SORT_SELECT.onchange = renderTable;

  loadData();
</script>

</body>
</html>